# v0.8.0 - Routing Profiles (Foundations)

> **Branch:** `feature/v0.8-routing-foundations`
> **Theme:** Add 5 foundational routing profile services that serve as prerequisites for advanced BGP/OSPF configuration
> **Breaking:** No
> **Upgrade:** `pip install --upgrade pan-scm-sdk`

---

## Standards

This version follows [Version Implementation Standards](../roadmap.md#version-implementation-standards):
- Agent orchestration: `.agent_harness/STRATEGY.md`
- Git workflow: `.agent_harness/git-workflow.md`

---

## Agent Assignment

| Phase | Agent | Tasks |
|-------|-------|-------|
| OBSERVE | Haiku | Review OpenAPI schemas for all 5 services (all under 120 lines); confirm no-POST status; check for shared model types across services |
| PLAN | Opus | Decompose into parallel BUILD tasks; identify shared model patterns |
| DESIGN | Sonnet | Design models for all 5 services; identify any reusable nested types |
| BUILD | Sonnet x3 | Task 1: Route Access List + Route Prefix List; Task 2: BGP Auth Profile + OSPF Auth Profile; Task 3: BGP Address Family Profile |
| TEST | Sonnet | Create model + service tests for all 5 services |
| VERIFY | Opus | Verify registration, exports, all tests pass |
| LEARN | Opus | Document batch implementation learnings |

---

## Tech Stack Additions

| Technology | Version | Purpose | Notes |
|------------|---------|---------|-------|
| None | -- | -- | All patterns established in v0.5.0-v0.7.0 |

---

## Features

| Feature | Priority | Description |
|---------|----------|-------------|
| Route Access List | P1 | `scm.route_access_list` - Manage route access lists for filtering routes by network/mask. Endpoint: `/config/network/v1/route-access-lists`. **No POST.** ~113 line schema. |
| Route Prefix List | P1 | `scm.route_prefix_list` - Manage route prefix lists for prefix-based route filtering. Endpoint: `/config/network/v1/route-prefix-lists`. **No POST.** ~102 line schema. |
| BGP Authentication Profile | P1 | `scm.bgp_auth_profile` - Manage BGP authentication profiles (MD5 authentication for BGP sessions). Endpoint: `/config/network/v1/bgp-authentication-profiles`. **No POST.** ~51 line schema. |
| OSPF Authentication Profile | P1 | `scm.ospf_auth_profile` - Manage OSPF authentication profiles (MD5/password authentication for OSPF adjacencies). Endpoint: `/config/network/v1/ospf-authentication-profiles`. **No POST.** ~82 line schema. |
| BGP Address Family Profile | P1 | `scm.bgp_address_family_profile` - Manage BGP address family profiles (IPv4/IPv6 unicast/multicast configuration). Endpoint: `/config/network/v1/bgp-address-family-profiles`. **No POST.** ~58 line schema. |

---

## Architecture

All 5 services follow the no-POST pattern established in v0.6.0. All have simple, relatively flat schemas.

### File Layout

```
scm/
├── config/network/
│   ├── route_access_list.py
│   ├── route_prefix_list.py
│   ├── bgp_auth_profile.py
│   ├── ospf_auth_profile.py
│   └── bgp_address_family_profile.py
├── models/network/
│   ├── route_access_list.py
│   ├── route_prefix_list.py
│   ├── bgp_auth_profile.py
│   ├── ospf_auth_profile.py
│   └── bgp_address_family_profile.py
tests/scm/
├── config/network/
│   ├── test_route_access_list.py
│   ├── test_route_prefix_list.py
│   ├── test_bgp_auth_profile.py
│   ├── test_ospf_auth_profile.py
│   └── test_bgp_address_family_profile.py
├── models/network/
│   ├── test_route_access_list_models.py
│   ├── test_route_prefix_list_models.py
│   ├── test_bgp_auth_profile_models.py
│   ├── test_ospf_auth_profile_models.py
│   └── test_bgp_address_family_profile_models.py
```

### Service Registration

Add to `scm/client.py` `service_imports` dict:
```python
"route_access_list": ("scm.config.network.route_access_list", "RouteAccessList"),
"route_prefix_list": ("scm.config.network.route_prefix_list", "RoutePrefixList"),
"bgp_auth_profile": ("scm.config.network.bgp_auth_profile", "BgpAuthProfile"),
"ospf_auth_profile": ("scm.config.network.ospf_auth_profile", "OspfAuthProfile"),
"bgp_address_family_profile": ("scm.config.network.bgp_address_family_profile", "BgpAddressFamilyProfile"),
```

---

## Model Summaries

### Route Access List (~113 line schema)
```python
class RouteAccessListBaseModel(BaseModel):
    name: str
    rules: Optional[List[RouteAccessListRule]] = None
    folder: Optional[str] = None
    snippet: Optional[str] = None
    device: Optional[str] = None

class RouteAccessListRule(BaseModel):
    sequence: Optional[int] = None
    action: Optional[str] = None        # "permit" or "deny"
    source: Optional[str] = None        # network/mask
    destination: Optional[str] = None
```

### Route Prefix List (~102 line schema)
```python
class RoutePrefixListBaseModel(BaseModel):
    name: str
    prefix: Optional[List[PrefixEntry]] = None
    folder: Optional[str] = None
    snippet: Optional[str] = None
    device: Optional[str] = None

class PrefixEntry(BaseModel):
    sequence: Optional[int] = None
    action: Optional[str] = None        # "permit" or "deny"
    network: Optional[str] = None       # CIDR
    ge: Optional[int] = None            # greater-than-or-equal prefix length
    le: Optional[int] = None            # less-than-or-equal prefix length
```

### BGP Authentication Profile (~51 line schema)
```python
class BgpAuthProfileBaseModel(BaseModel):
    name: str
    secret: Optional[str] = None        # MD5 secret
    folder: Optional[str] = None
    snippet: Optional[str] = None
    device: Optional[str] = None
```

### OSPF Authentication Profile (~82 line schema)
```python
class OspfAuthProfileBaseModel(BaseModel):
    name: str
    md5: Optional[List[Md5Key]] = None
    password: Optional[str] = None      # Simple password auth
    folder: Optional[str] = None
    snippet: Optional[str] = None
    device: Optional[str] = None

class Md5Key(BaseModel):
    key_id: Optional[int] = None
    key: Optional[str] = None
    preferred: Optional[bool] = None
```

### BGP Address Family Profile (~58 line schema)
```python
class BgpAddressFamilyProfileBaseModel(BaseModel):
    name: str
    ipv4_unicast: Optional[bool] = None
    ipv4_multicast: Optional[bool] = None
    ipv6_unicast: Optional[bool] = None
    ipv6_multicast: Optional[bool] = None
    folder: Optional[str] = None
    snippet: Optional[str] = None
    device: Optional[str] = None
```

---

## Testing Checklist

- [ ] All 5 services: list, get, update, fetch operations work with mocked data
- [ ] All 5 services: no create() or delete() methods (no-POST pattern)
- [ ] Route Access List: rule validation (permit/deny, valid network/mask)
- [ ] Route Prefix List: prefix entry validation (ge/le constraints)
- [ ] BGP Auth Profile: secret field accepted
- [ ] OSPF Auth Profile: MD5 key list and simple password modes
- [ ] BGP Address Family Profile: boolean flags validate correctly
- [ ] All 5 services registered in client.py
- [ ] All 5 services added to network __init__.py exports
- [ ] All response models use `extra="ignore"`
- [ ] CI pipeline passes

### Logical Router E2E Extension (REQUIRED)

The v0.7.0 Logical Router E2E tests (`tests/scm/api/test_logical_router_e2e.py`) proved that BGP peer groups
require a BGP Address Family Profile reference to satisfy the AFI/SAFI constraint. Once the BGP Address Family
Profile service is built in this version, the Logical Router E2E test suite MUST be extended to:

- [ ] Create a BGP Address Family Profile (e.g., with `ipv4_unicast=True`)
- [ ] Update the Logical Router's BGP config with peer groups that reference the address family profile
- [ ] Verify IBGP and EBGP peer groups with peers (ip/fqdn peer_address variants)
- [ ] Verify BGP peer connection options (timers, multihop, authentication via BGP Auth Profile)
- [ ] Clean up both the Address Family Profile and the Logical Router after testing

This validates the cross-service dependency chain: Logical Router -> BGP Peer Group -> BGP Address Family Profile.

See `tests/scm/api/test_logical_router_e2e.py::test_06_update_with_bgp` for the current base-config-only test.

---

## Migration Guide

```bash
# Upgrade
pip install pan-scm-sdk==0.8.0

# New service access
from scm.client import Scm

client = Scm(...)
client.route_access_list.list(folder="All")
client.route_prefix_list.list(folder="All")
client.bgp_auth_profile.list(folder="All")
client.ospf_auth_profile.list(folder="All")
client.bgp_address_family_profile.list(folder="All")
```
